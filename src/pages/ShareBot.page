<apex:page sidebar="false" showHeader="false" standardStylesheets="false">
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<head>
  <script type="text/javascript" src="{!URLFOR($Resource.ShareBot,'js/jqueryminjs.js')}"></script>
  <script type="text/javascript" src="{!URLFOR($Resource.ShareBot,'js/metadatajs.js')}"></script>
  <script type="text/javascript" src="{!URLFOR($Resource.ShareBot,'js/jszip.min.js')}"></script>
  <script type="text/javascript" src="{!URLFOR($Resource.ShareBot,'js/bootstrap.js')}"></script>
  <script type="text/javascript" src="{!URLFOR($Resource.ShareBot,'js/FileSaverJS.js')}"></script>
  
  <link rel="stylesheet" href="{!URLFOR($Resource.ShareBot,'css/BootstrapCss.css')}"/>
  <style>
   .clickli:hover,.likebutton:hover
   {
     font-size:120%;
     color: blue;
   }
   .clickli,.likebutton
   {
     cursor:pointer;
   }
   .XMLPane
   {
     white-space: pre-wrap; 
     background-color :#f2f2f2;
   }
   .sc2
   {
     display:none;
   }
   .pagebg
   {
     background: #f79d00;  /* fallback for old browsers */
background: -webkit-linear-gradient(to right, #64f38c, #f79d00);  /* Chrome 10-25, Safari 5.1-6 */
background: linear-gradient(to right, #64f38c, #00ecf7); /* W3C, IE 10+/ Edge, Firefox 16+, Chrome 26+, Opera 12+, Safari 7+ */



   }
   
      .load {
  position: relative;
  margin: 50px auto;
  width: 100px;
  height: 80px;
}

.gear {
  position: absolute;
  /*z-index: -10;*/
  width: 40px;
  height: 40px;
  -webkit-animation: spin 5s infinite;
          animation: spin 5s infinite;
}

.two {
  left: 40px;
  width: 80px;
  height: 80px;
  -webkit-animation: spin-reverse 5s infinite;
          animation: spin-reverse 5s infinite;
}

.three {
  top: 45px;
  left: -10px;
  width: 60px;
  height: 60px;
}

@-webkit-keyframes spin {
  50% {
    -webkit-transform: rotate(360deg);
            transform: rotate(360deg);
  }
}

@keyframes spin {
  50% {
    -webkit-transform: rotate(360deg);
            transform: rotate(360deg);
  }
}
@-webkit-keyframes spin-reverse {
  50% {
    -webkit-transform: rotate(-360deg);
            transform: rotate(-360deg);
  }
}
@keyframes spin-reverse {
  50% {
    -webkit-transform: rotate(-360deg);
            transform: rotate(-360deg);
  }
}
.lil-circle {
  position: absolute;
  border-radius: 50%;
  box-shadow: inset 0 0 10px 2px gray, 0 0 50px white;
  width: 100px;
  height: 100px;
  opacity: .65;
}

.blur-circle {
  position: absolute;
  top: -19px;
  left: -19px;
}

.text {
  color: lightgray;
  font-size: 18px;
  font-family: 'Open Sans', sans-serif;
  text-align: center;
}
    
.modal-dialog {
    width: 50%;
}    
 
.settingsTab
{
  cursor:pointer;
}    

  </style>
</head>
  <body>  
  <div class="container">
       <div class="row pagebg">
         <div class="col-md-12" style=""><font style="font-size:32px;"><image src="{!URLFOR($Resource.ShareBot,'resources/shareCareIcon.png')}" width="50" height="50"/><b>share<font color="white">B</font>ot.</b></font></div>
       </div>
       <div class="row " style="background-color:#ebebe0">
        
                 <div class="col-md-3 acordholder" style="background-color: #99FFAD; z-index:100;min-height: 100em" >
                    
                      <ul id="objlist" style="list-style:none"/>
                  
                 </div>
                 <div class="col-md-9 ">
                            <div>
                                  <p style="display:inline;font-size:228%">Sharing Rules</p>
                                  <p style="display:inline;margin-left: 57%;" class="settingsTab"><span onclick="opensettings();"><image src="{!URLFOR($Resource.ShareBot,'resources/GearPNG.png')}" width="25" height="25" />&nbsp;&nbsp;<b>Preferences</b></span><br/><br/>
                                  <span style="inline-flex">
                                    <button class="btn btn btn-success btn-sm" style="margin-left: 81%;" onClick='dwnldZip();'> Download Zip </button>
                                    <button class="btn btn btn-success btn-sm"  onClick='deployZip();'>Deploy</button>
                                  </span></p>
                                  <p >Existing Rules for <span class="objname"/></p>
                                  
                                  
                                  <u><font style="color: palevioletred;"><b>Criteria Based Rules</b></font></u>
                                  <table class="criteriarules table">
                                      <thead>
                                          <tr>
                                            
                                            <th>API Name</th>
                                            <th>Access Level</th>
                                            <th>Shared To</th>
                                            <th>Shared To Name</th>
                                            <th>Criterias</th>
                                            <th>Criteria Logic</th>
                                            <th></th>
                                            
                                          </tr>
                                      </thead>
                                      <tbody>
                                      </tbody>
                                  </table>
                                  <u><font style="color: palevioletred;"><b>Owner Based Rules</b></font></u>
                                  <table class="ownerrules table">
                                       <thead>
                                          <tr>
                                            
                                            <th>API Name</th>
                                            <th>Access Level</th>
                                            <th>Shared From</th>
                                            <th>Shared From Name</th>
                                            <th>Shared To</th>
                                            <th>Shared To Name</th>
                                            <th></th>
                                            
                                          </tr>
                                      </thead>
                                      <tbody>
                                      </tbody>
                                  </table>
                                  <table class="territoryrules table">
                                  </table>
                                  <button class="btn btn-primary" disabled="true" id="addnew" onclick="resetall();"> Add New Rule</button><!--data-toggle="modal" data-target="#myModal"-->
                            </div>
                            <div>
                            <h2>XML View</h2>
                            <p>Changes will reflect here</p>
                            <div class="XMLPane">
                            </div>
                            </div>
                 </div>
       </div>
      
  </div>
  <!-- Modal -->
<div id="myModal" class="modal fade" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">New Sharing Rule</h4>
      </div>
      <div class="modal-body">
        <p class="sc1">
           <input type="radio" name="ruletype" value="sharingCriteriaRules" checked="checked" onclick="renderrule.call(this);" id="CRRadio"> Based on criteria</input>&nbsp;&nbsp;&nbsp;&nbsp;
           <input type="radio" name="ruletype" value="sharingOwnerRules" onclick="renderrule.call(this);" id="OBRadio"> Based on record owner</input>
        </p>    
        <p class="sc1">
           <table style="width: 100%;">
           <tr>
           <td>
               
               <b>Label</b><br/>
               <input type="text" id="ruleLabel" placeholder="Input Name" class="clearthis" onblur="populateApi.call(this)"/><br/>
               
               <b>Name</b><br/>
               <input type="text" id="ruleName" placeholder="Input Unique API Name" class="clearthis"/><br/>
               
           </td>
           <td>
               <b>Access Level</b><br/>
               <select class="" id="acclevel" name="AccessLevel" value="">
                  <option value="Read">Read Only</option>
                  <option value="Edit"> Read / Write </option>
               </select><br/>   
               <b>Description</b><br/>
               <textarea name="message" id="ruledesc" rows="2" cols="30" class="clearthis"></textarea>
           </td>
           </tr>
           </table>
        </p>
        <p class="criteriaBased sc1">
           <b>Criterias</b><br/>
           <select class="objField clearthis" placeholder="Field Name" value="" onchange="populateOperators.call(this)"/>
            <select class="objField_oprator clearthis" value=""/>
           <input type="text" class="objField_value clearthis" placeholder="" data-toggle="tooltip" title=""/>
           Clone <input type="radio" class="cloneThis" name="clone" id="c1"/><br/><br/>
           
           
           <select class="objField clearthis" placeholder="Field Name" value="" onchange="populateOperators.call(this)"/>
            <select class="objField_oprator clearthis" value=""/>
           <input type="text" class="objField_value clearthis" placeholder="" data-toggle="tooltip" title=""/> 
           Clone <input type="radio" class="cloneThis" name="clone" id="c2"/><br/><br/>
           
           <select class="objField clearthis" placeholder="Field Name" value="" onchange="populateOperators.call(this)"/>
            <select class="objField_oprator clearthis" value=""/>
           <input type="text" class="objField_value clearthis" placeholder="" data-toggle="tooltip" title=""/> 
           Clone <input type="radio" class="cloneThis" name="clone" id="c3"/><br/><br/>
           
           <select class="objField clearthis" placeholder="Field Name" value="" onchange="populateOperators.call(this)"/>
            <select class="objField_oprator clearthis" value=""/>
           <input type="text" class="objField_value clearthis" placeholder="" data-toggle="tooltip" title=""/> 
           Clone <input type="radio" class="cloneThis" name="clone" id="c4"/><br/><br/>
           
           <select class="objField" placeholder="Field Name" value="" onchange="populateOperators.call(this)"/>
            <select class="objField_oprator clearthis" value=""/>
           <input type="text" class="objField_value clearthis" placeholder="" data-toggle="tooltip" title=""/> 
           Clone <input type="radio" class="cloneThis" name="clone" id="c5"/><br/><br/>
           
           <select class="objField clearthis" placeholder="Field Name" value="" onchange="populateOperators.call(this)"/>
            <select class="objField_oprator clearthis" value=""/>
           <input type="text" class="objField_value clearthis" placeholder="" data-toggle="tooltip" title=""/> 
           Clone <input type="radio" class="cloneThis" name="clone" id="c6"/><br/>
           <b>Filter Logic</b><br/>
           <input type="text" id="CriteriaFiletrLogic" placeholder="Specify filter logic if applies" class="clearthis"/> <br/>
        </p>
        <p class="ownerBased sc1" style="display:none;">
           <b>Records to be shared</b><br/>
           <select class="tobesharedType" id="shareFromType">
              <option value="group">Public Group</option>
              <option value="role"> Roles </option>
              <option value="rolesubordinate"> Roles and subordinates </option>
           </select>&nbsp;&nbsp;   
           <input type="text" class="objField6 clearthis" placeholder="Name" id="SFName"/>
           <input type="checkbox" id="sharefromClone" class="cloneThis_share clearthis"/> Clone
        </p>   
        <p class="sc1">
           <b>Share With</b><br/>
           <select id="shareWithType">
              <option value="group">Public Group</option>
              <option value="role"> Roles </option>
              <option value="rolesubordinate"> Roles and subordinates </option>
           </select>&nbsp;&nbsp;   
           <input type="text" id="SWName" placeholder="Name" class="clearthis"/>   
           <input type="checkbox" id="sharewithClone" class="cloneThis_share clearthis"/> Clone
        </p>  
        <p class="sc1 acconly" style="display:none;">
           <b>Level of access</b><br/>
           <table class="acconly">
           <tr>
           <td>
           Default Account, Contract and Asset Access &nbsp;&nbsp;
           </td>
           <td>
           <select id="acclevelaccess">
              <option value="Read">Read Only</option>
              <option value="Edit"> Read / Write </option>
           </select>&nbsp;&nbsp; <br/> 
           </td> 
           </tr>
           <tr>
           <td>
           Opportunity Access &nbsp;&nbsp;</td>
           <td>
           <select id="opplevelaccess">
              <option value="None">Private</option>
              <option value="Read">Read Only</option>
              <option value="Edit"> Read / Write </option>
           </select>&nbsp;&nbsp;  <br/>
           </td> 
           </tr>
           <tr>
           <td>
           Case Access &nbsp;&nbsp;</td> 
           <td>
           <select id="caselevelaccess">
              <option value="None">Private</option>
              <option value="Read">Read Only</option>
              <option value="Edit"> Read / Write </option>
           </select>&nbsp;&nbsp; <br/></td> 
            
           </tr> 
           </table>
        </p>
        <hr/> 
        
        <span class="clickli sc1" id="addMultiple" onclick="change2Screen2();"> <u>Add to multiple object >> </u></span><span style="margin-left:10%;color: #29a329;" class="addedNotification"></span><br/><br/>
        
        <p class="sc2"><ul class="sc2detail sc2"/></p>
        <span class="clickli sc2" id="addMultiple" onclick="change2Screen1();"> <u>Done >> </u></span>
        </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" onclick="createRuleXML();">Add</button>
        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
      </div>
    </div>

  </div>
</div>
<!-- Modal End--->
<!-- Edit Modal Start-->
<div id="editModal" class="modal fade" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title editmodal-header"></h4>
      </div>
      <div class="modal-body">
      <input type="text" value="" id="ruletype" style="display:none;"/>
        <p><table style="width: 100%;">
           <tr>
           <td>
               <b>Name</b><br/>
               <input type="text" id="ruleName_edit" placeholder="Input Unique API Name" disabled="disabled"/><br/>
               <b>Label</b><br/>
               <input type="text" id="ruleLabel_edit" placeholder="Input Name"/>
           </td>
           <td>
               <b>Access Level</b><br/>
               <select class="" id="acclevel_edit" name="AccessLevel_edit" value="">
                  <option value="Read">Read Only</option>
                  <option value="Edit"> Read / Write </option>
               </select><br/>   
               <b>Description</b><br/>
               <textarea name="message" id="ruledesc_edit" rows="2" cols="30"></textarea>
           </td>
           </tr>
           </table>
        </p>
        <p class="criteriaEditpane">
        <b>Criterias</b><br/>
           <span class="editFieldrows"/>
           <span class='likebutton' onclick="addfieldrow();"><b><font color="green" size="6">&nbsp;&nbsp;+&nbsp;&nbsp;</font></b></span><br/>
           <br/><b>Filter Logic</b><br/>
           <input type="text" id="CriteriaFiletrLogic_edit" placeholder="Specify filter logic if applies"/> <br/>
        </p>
        <p class="shareFromEditpane">
           <b>Share From</b><br/>
           <select id="shareFromType_edit" disabled="disabled">
              <option value="group">Public Group</option>
              <option value="role"> Roles </option>
              <option value="rolesubordinate"> Roles and subordinates </option>
           </select>&nbsp;&nbsp;   
           <input type="text" id="SFName_edit" placeholder="Name" disabled="disabled"/>            
        </p>
        <p>
           <b>Share With</b><br/>
           <select id="shareWithType_edit" disabled="disabled">
              <option value="group">Public Group</option>
              <option value="role"> Roles </option>
              <option value="rolesubordinate"> Roles and subordinates </option>
           </select>&nbsp;&nbsp;   
           <input type="text" id="SWName_edit" placeholder="Name" disabled="disabled"/>
        </p> 
        <p class="acconly_edit" style="display:none;">
           <b>Level of access</b><br/>
           <table class="acconly_edit">
           <tr>
           <td>
           Default Account, Contract and Asset Access &nbsp;&nbsp;
           </td>
           <td>
           <select id="acclevelaccess_edit">
              <option value="Read">Read Only</option>
              <option value="Edit"> Read / Write </option>
           </select>&nbsp;&nbsp; <br/> 
           </td> 
           </tr>
           <tr>
           <td>
           Opportunity Access &nbsp;&nbsp;</td>
           <td>
           <select id="opplevelaccess_edit">
              <option value="None">Private</option>
              <option value="Read">Read Only</option>
              <option value="Edit"> Read / Write </option>
           </select>&nbsp;&nbsp;  <br/>
           </td> 
           </tr>
           <tr>
           <td>
           Case Access &nbsp;&nbsp;</td> 
           <td>
           <select id="caselevelaccess_edit">
              <option value="None">Private</option>
              <option value="Read">Read Only</option>
              <option value="Edit"> Read / Write </option>
           </select>&nbsp;&nbsp; <br/></td> 
            
           </tr> 
           </table>
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" onclick="saveEdited();">Save</button>
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>

  </div>
</div>
<!-- Edit Modal End -->
<!-- deployment Modal Start-->
<div id="deploymentModal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title deploymentmodal-header"></h4>
      </div>
      <div class="modal-body">
         <center><span id="deploymentstat" style="font-weight:bold;"/></center>
         <span> <ul id="deploymentprob"/> </span>
         <center><img class="loaderimg" src="data:image/gif;base64,R0lGODlhZAAPAKEAAPT29Pz+/Pz6/P///yH/C05FVFNDQVBFMi4wAwEAAAAh+QQJCQADACwAAAAAZAAPAAACS5yPqcs9EZyctNqrIMS8+/9o4EiWoRaZ6iqhKAvHhvvKFkDn+s67s/jrCYc5AfF4RLyQzKENo3tKR7mp9eO7ajnArdeS+orH5DKpAAAh+QQJCQAMACwAAAAAZAAPAIMsLizc2tyEgoQ8OjyMioz8/vxEQkQ0MjTs6uyEhoQ8PjyMjoz///8AAAAAAAAAAAAEWpDJSau9OLNStP9gKI4Wx5Foqq6byb5w3JqdbN8eTeN8L+k7n0gxOAAAhgBwyWw2fy6oc0p1EhIJgWCBqHqnlN13/BWSmOb0a6lur3TueCoqr4tq9rx+z4dFAAAh+QQJCQAXACwAAAAAZAAPAIQsLiycnpxkZmRMSkyEgoTU0tQ8OjysrqyMjow0NjSsqqx8enxcWlyUlpQ0MjSkoqRsbmxUUlSEhoT8/vxEQkS0trSUkpT///8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFauAljmRpnmh6TZPqvnAszybL0niu76vN/8Bgz9YSGo8uIhHJbIqUS6dsAREwIgODIeEAOCrQsHjsGxbN5LRafFA8Ag0EQiIh2AvrvJK01Pv1UjRigYQ/YYWIO3uJjDhljZAyZ5GUlZaXPyEAIfkECQkAHAAsAAAAAGQADwCELC4snJ6cZGZk1NLUhIKETEpMvL68jI6MPDo8tLK0NDY0pKakfH58/P78jIqMXF5czM7MlJaUNDI0dHJ03NrchIaEVFJUxMbElJKUREJEtLa0rKqs////AAAAAAAAAAAABXQgJ45kaZ5oyjWN6r5wLM8my9J4ru+rzf/AYM/WEhqPLiIRyWyKlEunzKDZBCIVxkTwsBQyCIUEAKhAz2jo07dOu9/wBmUAuVATm8UVc3BUCAwEGnFxJEuEiIlFUjJojI8/Z5CTO0qUlzlsmJuNnJ6foKFCIQAh+QQJCQAoACwAAAAAZAAPAIUsLiycmpzMzsxsamzs6uy0srRMTkyEgoTk4uT09vSMjow8PjykpqS8vrzU1tRcXlw0NjSkoqR0dnT08vRUVlSMioz8/vyUlpTExsQ0MjScnpzU0tTs7uy8urxUUlSEhoTk5uT8+vyUkpRERkSsrqzEwsTc2tx8fnz///8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGhkCUcEgsGo/IJMpiUTqf0Kh0amQyqdisdru0cr/gcNfaFJvPTjIZzW4L1Wu3NDEBIRyCUocUuVROEgMPFAYjCxAZAAAecI2Ob16QjpOUlWohdAR2JhsCGHoFJAwRASIKFR8HJwcXlo9Da66ys3FyUq+2uVuNur27tb7BU5HCxbfGyMnKy2JBACH5BAkJACgALAAAAABkAA8AhSwuLJyenNTS1GRmZLy+vOzq7ISChExKTKyurPT29IyOjDw6PNze3MzKzHx6fDQ2NKyqrNza3MTGxPTy9IyKjFxeXLS2tPz+/JSWlDQyNKSipNTW1HRydMTCxOzu7ISGhFRSVLSytPz6/JSSlERCROTm5MzOzHx+fP///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAaKQJRwSCwaj8gk6nJROp/QqHRqZDKp2Kx2u7Ryv+Bw19oUm89OMhnNbgvVa7dULUp4SgxBg2CBBEYfJxwDFSAHJAsPGQAADnCPV2NlkpCVlpeVIhMTBXgRAiYdfCEQGgEYIwoUHwYnBgiYkW9esbW2cXJzj7m8X7u9wFpqwcRZXsXIU5PJzM3Oz19BACH5BAkJACcALAAAAABkAA8AhSwuLJyanMzOzGxqbOzq7LSytExOTISChKSmpNze3PT29Dw+PLy+vIyOjDQ2NKSipNTW1HR2dPTy9FxeXIyKjKyurOTm5Pz+/MTGxDQyNJyenOzu7Ly6vFRWVISGhKyqrOTi5Pz6/ERGRMTCxJSWlNza3Hx+fP///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAaJwJNwSCwaj8jk6XJROp/QqHRqZDKp2Kx2u7Ryv+Bw19oUm89OMhnNbgvVa7cUrg4pNoQERDAqVB4kFCYRAxMdBiILDhkAACJ0V2NlkpCVlpeYVnYSBBYgJXsYIxwFHwgaAYEUHgcHJg2QRGuZtLVxcnN0uLtfury/WmrAw1lexMdTk8jLzM3OX0EAIfkECQkAJQAsAAAAAGQADwCFLC4snJqczM7MbG5s7OrshIaETE5MtLK03N7c9Pb0PD48lJKUpKakfH58xMLEPDo81NbU9PL0jI6MXFpc5Obk/P78NDI0pKKkdHZ07O7sjIqMvLq85OLk/Pr8REZElJaUrK6shIKExMbE3NrcZGJk////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABonAknBILBqPyGSpUlE6n9CodGpkMqnYrHa7tHK/4HDX2hSbz04yGc1uC9VrtxROVyciBMRIINqAGAESIRgDJBMGHgoPFgCNHFdjZZF1lJWWl5QddxkUHAgQfA4bByAXAQEfCxoFBSEhDRmSkZOYtbVyVHW4u190vL9basDDWV7Ex1OyyMvMzc5cQQAh+QQJCQArACwAAAAAZAAPAIUEAgSEhoTExsRMSkzs6uykpqQkIiTU1tRkZmS0trSUlpT09vQcGhzMzsxUVlSsrqzc3tx8enycnpwMCgz08vQ0NjRsbmy8vrz8/vwEBgSMjozMysxUUlTs7uysqqzc2txsamycmpz8+vwcHhzU0tRcWly0srTk4uSkoqQ8OjzEwsT///8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGncCVcEgsGo/I5AqzUDqf0Kh0asSgQE2qdsvtCgyZUHdMLhcplQxgJDC731KKZcIJTCQYuH5flDBSHwsOKCJ5fFMYiYqLjI2KIhQEJx8kAhcmBRIaAREWCCUcAwYMbSsfDYlDjqusra6vryILCx2SEAckGyqXDx4oIQoaGglEhamwyMmLh1qrzM9mjtDTZIzU112K2Ntbhtzf4OHiekEAIfkECQkALwAsAAAAAGQADwCFBAIEhIaExMbEREJE5ObkJCYkrKqsZGZk1NbU9Pb0NDY0lJaUvLq8FBIUVFJUzM7M7O7sLC4sdHZ0jI6MtLK03N7c/P78PD48nJ6cxMLEHBocXFpcBAYEzMrMREZE7OrsLCosbG5s3Nrc/Pr8PDo8vL681NLU9PL0NDI0fHp8lJKUtLa0pKKkHB4cXF5c////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABqjAl3BILBqPyOTLklA6n9CodGq0rAJNqnbL7ZocCkN3TC4XEwcS6tIxu9/SxMKTwoAGJ7h+X2RsQgQjIRoSWXxSFomKi4yNjokjCRAEFQgdJSsGGCoBIRsIQhUeLSxDI4+oqaqrrKsjJycflCImDxmYBm1DHRoFDy8EAa3Dw4daEw1sHi6Jxs5mJy4cLQAHFs/YZBUoABoi2eBdDCAr4eZbFefq6+ztfEEAIfkECQkALQAsAAAAAGQADwCFFBYUjI6MzMrMVFJU5ObkbG5srK6sNDY0ZGJk9Pb0xMLEJCYknJ6c1NbUfH58REZEXFpc7O7stLa0PD48bGps/P78LC4spKak3N7chIaEHB4cnJqczM7MVFZU7OrsdHZ0tLK0PDo8ZGZk/Pr8xMbE3NrchIKETE5MXF5c9PL0vLq8NDI0rKqs////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABqvAlnBILBqPyGSrMlI6n9CodGqsNEBNqnbL7RI2JlJ3TC4XR6yAw1Qyu9/SkWBjUHwcCbh+X8SwDBEjDCIMWXxSFYmKi4yNjo8jCREeGA0CEiweQh4mECpDDQMHKxYWBY+oqaqrrKuRKR4EGCUERCUdKG0eEwAnJiYOLCOtxI+HWgYnFA0oGgMRx9FmCRkhDwsDbdLbYwQQKyEY3ONdAgNi5Olatert7u/we0EAIfkECQkAKgAsAAAAAGQADwCFLC4snJqczM7MZGZk7OrsTEpMhIKEvLq83N7c9Pb0jI6MPD48rKqsXFpc1NbUdHZ0xMbENDY0pKKk9PL0VFZUjIqM5Obk/P78lJaUNDI0nJ6c1NLUbGps7O7sTE5MhIaEvL685OLk/Pr8lJKUREZErK6sZGJk3NrcfH58zMrM////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABqlAlXBILBqPyKTqclE6n9CodGq8TEJNqnbL7YoQG0J3TC4XL5aTINUxu9/SS8JiIUAgIrh+XxR1CCIXDgcCeXxTTImKi4yNjo4JE4YTECUnQyEfHCYUHiQLERkAAAUEj6eoqaqriyKGQh0MDBYqEygNKBoBIyMVHx8GBgoJrMWHWg4SswEDHxPH0GYiIAoKDxW00dpjExLB2dvhWwgYl+LnWs/o6+zt7ntBACH5BAkJACgALAAAAABkAA8AhSwuLJyanMzOzGxubOzq7LS2tExKTISGhNze3KyqrPT29MTCxDw6PNTW1Hx6fFxaXJSWlKSipPTy9IyOjOTm5LSytPz+/MzKzISChDQyNNTS1Ozu7Ly6vFRSVIyKjOTi5KyurPz6/MTGxERCRNza3Hx+fGRiZKSmpP///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAabQJRwSCwaj8gkymJROp/QqHRqZDKp2Kx2u7Ryv+Bw19oUm89OMjNURrvfaktI0X5H4/i8fh8XyjcKQxILFScBExgOAyYPBgYjDBkAAAwifJeYmZpqRBYSBIEhIiAcIgscBSAnEQEQExMHBxglHgibenZYChQUCg2lIbnCYZ4kJCIXEsPLXyEfGgKBzNNaCiQb1NlZwdrd3t/gbkEAIfkECQkAIwAsAAAAAGQADwCFLC4snJqczM7MbGps7OrstLK0TE5MhIKEjI6MPD48pKak5OLk9Pb0xMLENDY0pKKk1NbU9PL0ZGJkjIqMlJaUNDI0nJ6cdHZ07O7svLq8VFZUhIaElJKUREZErK6s5Obk/P78xMbE3Nrc////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABonAkXBILBqPyOQIBFI6n9CodGpkMqnYrHa7tHK/4HDX2hSbz04yGc1uC9VrtxROr9vv8Lf3HSGIRAIhGR4PFAgHFwMSGgYdCQ4VAJJ4lJWWl0RrIAwEGBgfCyIQgQ2DHgoWARwcExMHrweXanJUagwRZbS6W7a5u79Ys8DDwVfEx1O+yMvMzc5cQQAh+QQJCQAmACwAAAAAZAAPAIUsLiycmpzU0tRsbmy0trTs6uxMSkyEhoTEwsT09vSsrqzc3tyUkpQ8OjxcWlykoqTc2tx8eny8vrz08vSMjozMysz8/vw0MjTU1tS8urzs7uxUUlSMiozExsT8+vy0srTk4uSUlpREQkRkYmSkpqSEgoT///8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGiUCTcEgsGo/IpMliUTqf0Kh0amQyqdisdru0cr/gcNfaFJvPTjIZzW4L1Wu3FE6v2+/wt1dP9mg0IBACHRIfDwEUJREDIw4bIiINFwCUFXiXmJl1RGtwHh4JE4AgCxgVFQgZBAokDyEhDBQHByWKC5hyVJu5vFx0vcBbasHEWXvFyHPJy8zNzmJBACH5BAkJACUALAAAAABkAA8AhSwuLJyanNTS1GRmZLS2tOzq7ISChExKTKyqrPT29IyOjDw6PNze3MTCxDQ2NKSipHRydPTy9IyKjFxeXLSytPz+/JSWlDQyNJyenNza3Ly+vOzu7ISGhFRSVKyurPz6/JSSlERCROTm5MzKzHx6fP///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAaLwJJwSCwaj8hkqVJROp/QqHRqZDKp2Kx2u7Ryv+Bw19oUm89OMhnNbgvVa7cUTq/b7/C3V3//RDYiGQIjGhQIGCAcJBADEx0HIQsOFwAAIHiYmZpXQ2uZHwkJGwUiDBkjIw0aBB4IDwEWIAocHAYGJA10clR1u75fur/CWmrDxll7x8pzy83Oz9BiQQAh+QQJCQAqACwAAAAAZAAPAIUsLiycmpzMzsxkZmTs6uy0trRMTkyEgoTc3tz09vTEwsSMjow8PjysqqzU1tRcXlw0NjSkoqR8fnz08vS8vryMiozk5uT8/vzMysyUlpQ0MjScnpzU0tR0cnTs7uy8urxUVlSEhoTk4uT8+vzExsSUkpREQkS0srTc2txkYmT///8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGikCVcEgsGo/IpOpyUTqf0Kh0amQyqdisdru0cr/gcNfaFJvPTjIZzW4L1Wu3FE6v2+/wt1ePV48SHgQIDhgKBQ0bGRUSHQMPIAYmDBAaAAApfZmadERrm2Qjf4EWCCgcAiSGJw0RGwElCxUhBwcSG2Vyc5y5vFy7vcBZasHEwlfFyFO4yczNzs9fQQAh+QQJCQAgACwAAAAAZAAPAIU8PjykoqTU1tR0dnTs7uy8uryMjoxUVlSsrqzk4uT8+vzExsScmpxMTkysqqyEgoT09vRkYmTs6uxERkSkpqTc2tz08vTEwsSUlpS0srTk5uT8/vzMzsycnpyMioxsamz///8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGfECQcEgsGo/IJGizUTqf0Kh0amQyqdisdru0cr/gcNfaFJvPTjIZzW4L1Wu3FE6v2+/wt1eP70MsEhUVHAsFCAEYBg8DHxEHDRMAfZOUeUNrlXgKfwQaCRUChBcFGRQUHQyJHnJUdayvX3Sws1tqtLdZe7i7c7y+v8DBYkEAIfkECQkAFgAsAAAAAGQADwCEfHp8xMLE5OLkpKak1NLU9PL0jI6MtLK03Nrc/Pr8zMrM7OrshIKExMbErK6s1NbU9Pb0nJqcvLq83N7c/P787O7s////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABWugJY5kaZ5oalGU6r5wLM8my9J4ru+rzf/AYM/WEhqPLiIRyWyKlEunDEqtWq/Qp0+L7UITlYoAQWhIDoOIgQHwut9bbgsOT0AKYsHkoVAEzg5SNFWChT9Uhok7SoqNOXGOkTFFkpWWl5hAIQAh+QQJCQAMACwAAAAAZAAPAIO8vrzk5uT09vTU0tTs7uz8/vzc2tzMyszs6uz8+vz08vTc3tz///8AAAAAAAAAAAAEWpDJSau9OLNStP9gKI4Wx5Foqq6byb5w3JqdbN8eTeN8L+k7nwhILBqPwJ9LiWw2EwpCwDA4AJzY7JLZ0XqBgigisDAIScWz+kVcu1e6tzy1ndtDtbt+z+/DIgAh+QQJCQADACwAAAAAZAAPAAACS5yPqcs9EZyctNqrIMS8+/9o4EiWoRaZ6iqhKAvHhvvKFo3n+k7Pos8LCl0CwPCIRLyQzKDAhslBpyMc9fpxYbedH/d7A4vH5LKpAAA7"/></center>
      </div>
      <div class="modal-footer">
      <button type="button" class="btn btn-default deployclose" data-dismiss="modal">Close</button>
      </div>
    </div>

  </div>
</div>
<!-- deployment Modal End -->
<!-- pre loader Modal Start-->
<div id="preLoaderModal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title"></h4>
      </div>
      <div class="modal-body">
         <div class="load">
          <div class="gear one">
            <svg id="blue" viewbox="0 0 100 100" fill="#94DDFF">
              <path d="M97.6,55.7V44.3l-13.6-2.9c-0.8-3.3-2.1-6.4-3.9-9.3l7.6-11.7l-8-8L67.9,20c-2.9-1.7-6-3.1-9.3-3.9L55.7,2.4H44.3l-2.9,13.6      c-3.3,0.8-6.4,2.1-9.3,3.9l-11.7-7.6l-8,8L20,32.1c-1.7,2.9-3.1,6-3.9,9.3L2.4,44.3v11.4l13.6,2.9c0.8,3.3,2.1,6.4,3.9,9.3      l-7.6,11.7l8,8L32.1,80c2.9,1.7,6,3.1,9.3,3.9l2.9,13.6h11.4l2.9-13.6c3.3-0.8,6.4-2.1,9.3-3.9l11.7,7.6l8-8L80,67.9      c1.7-2.9,3.1-6,3.9-9.3L97.6,55.7z M50,65.6c-8.7,0-15.6-7-15.6-15.6s7-15.6,15.6-15.6s15.6,7,15.6,15.6S58.7,65.6,50,65.6z"></path>
            </svg>
          </div>
          <div class="gear two">
            <svg id="pink" viewbox="0 0 100 100" fill="#FB8BB9">
              <path d="M97.6,55.7V44.3l-13.6-2.9c-0.8-3.3-2.1-6.4-3.9-9.3l7.6-11.7l-8-8L67.9,20c-2.9-1.7-6-3.1-9.3-3.9L55.7,2.4H44.3l-2.9,13.6      c-3.3,0.8-6.4,2.1-9.3,3.9l-11.7-7.6l-8,8L20,32.1c-1.7,2.9-3.1,6-3.9,9.3L2.4,44.3v11.4l13.6,2.9c0.8,3.3,2.1,6.4,3.9,9.3      l-7.6,11.7l8,8L32.1,80c2.9,1.7,6,3.1,9.3,3.9l2.9,13.6h11.4l2.9-13.6c3.3-0.8,6.4-2.1,9.3-3.9l11.7,7.6l8-8L80,67.9      c1.7-2.9,3.1-6,3.9-9.3L97.6,55.7z M50,65.6c-8.7,0-15.6-7-15.6-15.6s7-15.6,15.6-15.6s15.6,7,15.6,15.6S58.7,65.6,50,65.6z"></path>
            </svg>
          </div>
          <div class="gear three">
            <svg id="yellow" viewbox="0 0 100 100" fill="#FFCD5C">
              <path d="M97.6,55.7V44.3l-13.6-2.9c-0.8-3.3-2.1-6.4-3.9-9.3l7.6-11.7l-8-8L67.9,20c-2.9-1.7-6-3.1-9.3-3.9L55.7,2.4H44.3l-2.9,13.6      c-3.3,0.8-6.4,2.1-9.3,3.9l-11.7-7.6l-8,8L20,32.1c-1.7,2.9-3.1,6-3.9,9.3L2.4,44.3v11.4l13.6,2.9c0.8,3.3,2.1,6.4,3.9,9.3      l-7.6,11.7l8,8L32.1,80c2.9,1.7,6,3.1,9.3,3.9l2.9,13.6h11.4l2.9-13.6c3.3-0.8,6.4-2.1,9.3-3.9l11.7,7.6l8-8L80,67.9      c1.7-2.9,3.1-6,3.9-9.3L97.6,55.7z M50,65.6c-8.7,0-15.6-7-15.6-15.6s7-15.6,15.6-15.6s15.6,7,15.6,15.6S58.7,65.6,50,65.6z"></path>
            </svg>
          </div>
          <div class="lil-circle"></div>
          <svg class="blur-circle">
            <filter id="blur">
              <fegaussianblur in="SourceGraphic" stddeviation="13"></fegaussianblur>
            </filter>
            <circle cx="70" cy="70" r="66" fill="transparent" stroke="white" stroke-width="40" filter="url(#blur)"></circle>
          </svg>
        </div>
        <div class="text">Fetching Metadata....</div>
      </div>
      <!--<div class="modal-footer">
      <button type="button" class="btn btn-default deployclose" data-dismiss="modal">Close</button>
      </div>-->
    </div>

  </div>
</div>
<!-- pre loader Modal End -->
<!-- Settings Modal Start-->
<div id="settingsModal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title"> Settings </h4>
      </div>
      <div class="modal-body">
       <p>
         <u><b>NameSpace Prefix</b></u><br/>
         <input type="text" class="nameSpacePrefix" placeholder="No Value Specified" /><br/><br/>
       
         <u><b>NameSpace Sufix</b></u><br/>
         <input type="text" class="nameSpacesufix" placeholder="No Value Specified" /><br/><br/>
         
         <u><b>Sample Format</b></u><br/>
         <span><b class="namespaceoutput"></b></span>
       
       </p>  
      </div>
      <div class="modal-footer">
      <button type="button" class="btn btn-default" onclick="saveSettings();">Save</button>
      <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>

  </div>
</div>
<!-- Settings Modal End -->
  </body>
  <script>
    
    var conn = new jsforce.Connection({accessToken: '{!$API.Session_Id}'});
    var zip = new JSZip();
    var deployzip = new JSZip();
        deployzip.folder('root');
        deployzip.folder('root/sharingRules');
    console.log(deployzip);
    var types = [{type: 'SharingRules'}];//SharingRules
    var Components = [];
    var allObjs = [];
    var selected_multiobject = [];
    var GlobalLoadedXML;
    var deployComponent = '';
    var deploycomponent_type = [];
    var currentObjDescribe ;
    var currentObjFieldTypeMap = [];
    var case_level='';
    var opp_level='';
    var contact_level='';
    
    //pre-Loader init//////////////////
    $("#preLoaderModal").modal({backdrop:'static',keybord:'false'});
    
    
    
    
    /////////////////To Populate side list/////////////////////////
    conn.metadata.list([{type: 'CustomObject'}], '48.0', function(err, metadata) {
    if (err) { return console.error('err', err); }
    var objects_2_fetch=[];
    var j=0;
    for(var i=0;i<metadata.length;i++)
      {
      
         allObjs[i] = metadata[i].fullName;
         if(allObjs[i].indexOf('__c') != -1 || allObjs[i] == 'Account' || allObjs[i] == 'Oppertunity' || allObjs[i] == 'Lead' || allObjs[i] == 'Case' || allObjs[i] == 'Contact' || allObjs[i] == 'Campaign')
           {
             Components[j] = metadata[i].fullName;
             $("#objlist").append('<li onclick="getRules.call(this)" class="clickli">'+metadata[i].fullName+'</li>');
             var tempobj={};
             tempobj.members = metadata[i].fullName;
             tempobj.name = 'SharingRules';
             
             objects_2_fetch[j]=tempobj;
             j++;
           }  
         
      }   
       
       console.log(objects_2_fetch);
       retrivesharing(objects_2_fetch);
       
    });
    
    
    
    
    
    
    
    /////////////////To Populate object list in multiple add scenario/////////////////////////
    conn.metadata.list([{type: 'CustomObject'}], '48.0', function(err, metadata) {
    if (err) { return console.error('err', err); }
    
    for(var i=0;i<metadata.length;i++)
      {
      
         allObjs[i] = metadata[i].fullName;
        if(allObjs[i].indexOf('__c') != -1 || allObjs[i] == 'Account' || allObjs[i] == 'Oppertunity' || allObjs[i] == 'Lead' || allObjs[i] == 'Case' || allObjs[i] == 'Contact' || allObjs[i] == 'Campaign')
         $(".sc2detail").append('<li><input type="checkbox" class="multiobjectselection" data-objname="'+metadata[i].fullName+'" onclick="">'+metadata[i].fullName+'</input></li>');
         
         
         
      }   
       
       
       
       
    });
    
  
function retrivesharing(fetch)
{
  
  
  conn.metadata.retrieve({
                           apiVersion: '48.0',
                           singlePackage: true,
                           unpackaged: {
                              types: fetch
                            }
                          },
                          function(err,result)
                          {
                            if(err){console.log(err);}
                                //console.log(result);
                            checkretrivalstat(result.id);
                          }
                        );
}
  
   
  
function checkretrivalstat (retid)
{
   conn.metadata.checkRetrieveStatus (retid,function(err,result){
       if(result.status!='Succeeded')
       {
         checkretrivalstat(retid);
       }
       else
       {
         //console.log(result);
         initiateZip (result.zipFile);
       }  
   });
   
}


function initiateZip (retZip)
{
  
         zip.loadAsync(retZip , {base64: true,createFolders: true}).then(function (zip) {console.log(zip.files);
            
                    zip.file("package.xml").async("string").then(function (data) {
                       console.log(data);
                     
                    });
                    $('#preLoaderModal').modal('hide');
         });
         

}

function getRules()
{
   var comName = $(this).text()+'.sharingRules';
   var comNameid = $(this).text();
   $(".objname").text($(this).text());
   zip.folder('sharingRules').file(comName).async("string").then(function (data) {
                       populateRules(data);
                    });
   $("#addnew").removeAttr("disabled");
   
}

function populateRules(data)
{
  $(".XMLPane").text(data);
  GlobalLoadedXML = data;
  $(".criteriarules tbody").empty();
  $(".ownerrules tbody").empty();
  $(".territoryrules tbody").empty();
  parser = new DOMParser();
  xmlDoc = parser.parseFromString(data,"text/xml");
  
  
  //For Criteri Rules
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////
  var criteriarules = xmlDoc.getElementsByTagName("sharingCriteriaRules");
  for(var i=0;i<criteriarules.length;i++)
  {
     var APIName = criteriarules[i].getElementsByTagName('fullName').length>0 ? criteriarules[i].getElementsByTagName('fullName')[0].innerHTML : '';
     var AccLevel = criteriarules[i].getElementsByTagName('accessLevel').length>0 ? criteriarules[i].getElementsByTagName('accessLevel')[0].innerHTML : '';
     var CriteriaLogic = criteriarules[i].getElementsByTagName('booleanFilter').length>0 ? criteriarules[i].getElementsByTagName('booleanFilter')[0].innerHTML : 'AND applies for all';
     var SharedTo = criteriarules[i].getElementsByTagName('sharedTo');
     var label = criteriarules[i].getElementsByTagName('fullName').length>0 ? criteriarules[i].getElementsByTagName('label')[0].innerHTML : '';
     var specialEdit = '';
     
     var SharedtoName = '';
     var SharedtoType = '';
     var CritariaString = '';
     
     if($('.objname').text() == 'Account')
     {
       var oppacc = criteriarules[i].getElementsByTagName('accountSettings').length>0 ? criteriarules[i].getElementsByTagName('accountSettings')[0].getElementsByTagName('opportunityAccessLevel')[0].innerHTML : '';
       var caseacc = criteriarules[i].getElementsByTagName('accountSettings').length>0 ? criteriarules[i].getElementsByTagName('accountSettings')[0].getElementsByTagName('caseAccessLevel')[0].innerHTML : '';
       
       var tempAccLevel = "<ul><li>Account, Contract and Asset  :  "+AccLevel+"</li>";
       tempAccLevel += "<li>Opportunity  :  "+oppacc+"</li>";
       tempAccLevel += "<li>Case  :  "+caseacc+"</li></ul>";
       
       specialEdit = caseacc+"-"+AccLevel+"-"+oppacc;
       AccLevel = tempAccLevel;
       
     }
     
     if(SharedTo.length>0)
     {
       var sharedto_child = SharedTo[0].childNodes[1];
       console.log(sharedto_child);
       
       if(sharedto_child.tagName == 'role')
       {
         SharedtoName = sharedto_child.innerHTML ;
         SharedtoType = 'Role';
       }  
       if(sharedto_child.tagName == 'roleAndSubordinates')
       {
         SharedtoName = sharedto_child.innerHTML ;
         SharedtoType = 'Role & Subordinates';
       }  
       if(sharedto_child.tagName == 'allInternalUsers')
       {
         SharedtoName = 'All Internal Users';
         SharedtoType = 'Public Group';
       } 
       if(sharedto_child.tagName == 'group')
       {
         SharedtoName = sharedto_child.innerHTML;
         SharedtoType = 'Public Group';
       }  
         
     }    
     var critariaitems = criteriarules[i].getElementsByTagName('criteriaItems');
     for(var e=0;e<critariaitems.length;e++)
     {
        var temp='';
        
        temp = '<b>'+critariaitems[e].getElementsByTagName('field')[0].innerHTML +'</b> <i>'+
               critariaitems[e].getElementsByTagName('operation')[0].innerHTML +'</i> <b>'+
               critariaitems[e].getElementsByTagName('value')[0].innerHTML +'</b>';
               
        CritariaString += '<li>'+ temp+'</li>';
     }
     
     
     //populate Table row
     var temprow = '';
     
     if($('.objname').text() == 'Account')
     {
            temprow = '<tr><td>'+APIName+'</td><td>'+AccLevel+'</td><td>'+SharedtoType+'</td><td>'+SharedtoName
        +'</td><td style="white-space: pre-wrap;"><ol>'+CritariaString+'</ol></td><td>'+ CriteriaLogic 
        +'</td><td><button type="button" class="btn btn-default" data-rulename="'+APIName+'" data-alev="'+specialEdit
        +'"  data-shto="'+SharedtoType+'" data-shton="'+SharedtoName+'" data-crst="'+CritariaString+'" data-crlg="'+CriteriaLogic+'" data-lbl="'+label
        +'" data-dismiss="modal" data-rtype="sharingCriteriaRules" onclick="editRule.call(this);" data-toggle="modal" data-target="#editModal">Edit</button></td></tr>';
     }
     else
     {
            temprow = '<tr><td>'+APIName+'</td><td>'+AccLevel+'</td><td>'+SharedtoType+'</td><td>'+SharedtoName
        +'</td><td style="white-space: pre-wrap;"><ol>'+CritariaString+'</ol></td><td>'+ CriteriaLogic 
        +'</td><td><button type="button" class="btn btn-default" data-rulename="'+APIName+'" data-alev="'+AccLevel
        +'"  data-shto="'+SharedtoType+'" data-shton="'+SharedtoName+'" data-crst="'+CritariaString+'" data-crlg="'+CriteriaLogic+'" data-lbl="'+label
        +'" data-dismiss="modal" data-rtype="sharingCriteriaRules" onclick="editRule.call(this);" data-toggle="modal" data-target="#editModal">Edit</button></td></tr>';
     }
          
        
        
        
        $(".criteriarules tbody").append(temprow);
        
        
     
  }
  //For Owner Rules
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////
  var criteriarules = xmlDoc.getElementsByTagName("sharingOwnerRules");
  for(var i=0;i<criteriarules.length;i++)
  {
     var APIName = criteriarules[i].getElementsByTagName('fullName').length>0 ? criteriarules[i].getElementsByTagName('fullName')[0].innerHTML : '';
     var AccLevel = criteriarules[i].getElementsByTagName('accessLevel').length>0 ? criteriarules[i].getElementsByTagName('accessLevel')[0].innerHTML : '';
     var SharedFrom = criteriarules[i].getElementsByTagName('sharedFrom');
     var SharedTo = criteriarules[i].getElementsByTagName('sharedTo');
     var label = criteriarules[i].getElementsByTagName('fullName').length>0 ? criteriarules[i].getElementsByTagName('label')[0].innerHTML : '';
     var specialEdit = '';
     
     var SharedtoName = '';
     var SharedtoType = '';
     var SharedfromName = '';
     var SharedfromType = '';
     
     if($('.objname').text() == 'Account')
     {
       var oppacc = criteriarules[i].getElementsByTagName('accountSettings').length>0 ? criteriarules[i].getElementsByTagName('accountSettings')[0].getElementsByTagName('opportunityAccessLevel')[0].innerHTML : '';
       var caseacc = criteriarules[i].getElementsByTagName('accountSettings').length>0 ? criteriarules[i].getElementsByTagName('accountSettings')[0].getElementsByTagName('caseAccessLevel')[0].innerHTML : '';
       
       var tempAccLevel = "<ul><li>Account, Contract and Asset  :  "+AccLevel+"</li>";
       tempAccLevel += "<li>Opportunity  :  "+oppacc+"</li>";
       tempAccLevel += "<li>Case  :  "+caseacc+"</li></ul>";
       
       specialEdit = caseacc+"-"+AccLevel+"-"+oppacc;
       AccLevel = tempAccLevel;
       
     }
     
     if(SharedTo.length>0)
     {
       var sharedto_child = SharedTo[0].childNodes[1];
       console.log(sharedto_child);
       
       if(sharedto_child.tagName == 'role')
       {
         SharedtoName = sharedto_child.innerHTML ;
         SharedtoType = 'Role';
       }  
       if(sharedto_child.tagName == 'roleAndSubordinates')
       {
         SharedtoName = sharedto_child.innerHTML ;
         SharedtoType = 'Role & Subordinates';
       }  
       if(sharedto_child.tagName == 'allInternalUsers')
       {
         SharedtoName = 'All Internal Users';
         SharedtoType = 'Public Group';
       }  
       if(sharedto_child.tagName == 'group')
       {
         SharedtoName = sharedto_child.innerHTML;
         SharedtoType = 'Public Group';
       }
         
     }   
     
     
     if(SharedFrom.length>0)
     {
       var sharedFrom_child = SharedFrom[0].childNodes[1];
       console.log(sharedFrom_child);
       
       if(sharedFrom_child.tagName == 'role')
       {
         SharedfromName = sharedFrom_child.innerHTML ;
         SharedfromType = 'Role';
       }  
       if(sharedFrom_child.tagName == 'roleAndSubordinates')
       {
         SharedfromName = sharedFrom_child.innerHTML ;
         SharedfromType = 'Role & Subordinates';
       }  
       if(sharedFrom_child.tagName == 'allInternalUsers')
       {
         SharedfromName = 'All Internal Users';
         SharedfromType = 'Public Group';
       }
       if(sharedFrom_child.tagName == 'group')
       {
         SharedfromName  = sharedFrom_child.innerHTML;
         SharedfromType = 'Public Group';
       }  
         
     }     
     
     
     //populate Table row
        var temprow ='';
        if($('.objname').text() == 'Account')
        {
            temprow = '<tr><td>'+APIName+'</td><td>'+AccLevel+'</td><td>'+SharedfromType+'</td><td>'+SharedfromName
            +'</td><td>'+SharedtoType+'</td><td>'+ SharedtoName
            +'</td><td><button type="button" class="btn btn-default" data-rulename="'+APIName+'" data-alev="'+specialEdit
            +'"  data-shto="'+SharedtoType+'" data-shton="'+SharedtoName+'" data-shfrm="'+SharedfromType+'" data-shfrmn="'+SharedfromName+'" data-lbl="'+label
            +'" data-dismiss="modal" data-rtype="sharingOwnerRules" onclick="editRule.call(this);" data-toggle="modal" data-target="#editModal">Edit</button></td></tr>';
        }
        else
        {
             temprow = '<tr><td>'+APIName+'</td><td>'+AccLevel+'</td><td>'+SharedfromType+'</td><td>'+SharedfromName
            +'</td><td>'+SharedtoType+'</td><td>'+ SharedtoName
            +'</td><td><button type="button" class="btn btn-default" data-rulename="'+APIName+'" data-alev="'+AccLevel
            +'"  data-shto="'+SharedtoType+'" data-shton="'+SharedtoName+'" data-shfrm="'+SharedfromType+'" data-shfrmn="'+SharedfromName+'" data-lbl="'+label
            +'" data-dismiss="modal" data-rtype="sharingOwnerRules" onclick="editRule.call(this);" data-toggle="modal" data-target="#editModal">Edit</button></td></tr>';
        }       
        
        
        
        $(".ownerrules tbody").append(temprow);
  }
  
  //conn.cache.clear();
  conn.describe($('.objname').text(), function(err, meta) {
      if (err) { return console.error(err); }
      console.log('Label : ' + meta.label);
      console.log('Num of Fields : ' + meta.fields.length);
      console.log(meta);
      currentObjDescribe = meta;
    });
  
  
  
     
}
function renderrule()
{
   if($(this).val() == 'sharingOwnerRules')
    { 
     $(".ownerBased").show();
     $(".criteriaBased").hide();
    }
    if($(this).val() == 'sharingCriteriaRules')
    { 
     $(".ownerBased").hide();
     $(".criteriaBased").show();
    }

}
function change2Screen2()
{

  $('.sc1').hide();
  $('.sc2').show();

}
function change2Screen1()
{

  $('.sc1').show();
  $('.sc2').hide();
  $(".multiobjectselection").each(function(){
      
       if($(this).prop("checked") == true)
         selected_multiobject.push($(this).attr('data-objname'));
      
  });
  console.log(selected_multiobject);
  $(".addedNotification").text(selected_multiobject.length+' other objects selected with this');
}

function includecomponent(name2add,ruleType2add)
{
  var rule2add = name2add+'';
  
  if(deployComponent.indexOf(rule2add) == -1)
  {
    deployComponent += $('.objname').text()+'.'+rule2add+'-';
    deploycomponent_type[$('.objname').text()+'.'+rule2add] = ruleType2add;
  }  
  
  console.log(deployComponent);  
  console.log(deploycomponent_type);  
}


function createRuleXML()
{
  var ruletype = $('input[name="ruletype"]:checked').val();
  var rulename = $('#ruleName').val();
  var ruleLabel = $('#ruleLabel').val();
  var ruledesc = $('#ruledesc').val();
  var accesslevel = $( "#acclevel" ).val();
  var filterLogic = $( "#CriteriaFiletrLogic" ).val();
  var sharewithType = $('#shareWithType').val();
  var sharewithName = $('#SWName').val();
  var sharefromType = $('#shareFromType').val();
  var sharefromName = $('#SFName').val();
  
  if($('.objname').text() == 'Account')
  {
     contact_level = $("#acclevelaccess").val();
     opp_level = $("#opplevelaccess").val();
     case_level = $("#caselevelaccess").val();
  }
  
  
    
  var cr_fields = [];
  var cr_ops = [];
  var cr_vals = [];
  var clone_cr_vals = [];
  var clone_shareWith_vals = [];
  var clone_shareFrom_vals = [];
  var individual_rules = [];
  var cloneIndex = "0";
  var cloneField;
  var cloneShareWith='0';
  var cloneShareFrom='0';
  
  var NamePre = '';
  var NameSuf = '';
  
  if(sessionStorage.getItem('sharePrefix') && sessionStorage.getItem('sharePrefix').length>0)
      NamePre = sessionStorage.getItem('sharePrefix')+'_';
  else
      NamePre = '';
  
  if(sessionStorage.getItem('shareSufix') && sessionStorage.getItem('shareSufix').length>0)
      NameSuf = '_'+sessionStorage.getItem('shareSufix');
  else
      NameSuf = '';
  
  var i= 0;
  $(".objField").each(function(){
      var fieldName = $(this).val();
      if( fieldName.length > 0 && fieldName!='none')
      {
         cr_fields[i] = fieldName;
         i++;
      }
      
  });
  
  i= 0;
  $(".objField_oprator").each(function(){
      var opName = $(this).val();
      if( opName && opName.length > 0)
      {
         cr_ops[i] = opName ;
         i++;
      }
      
  });
  
  i= 0;
  $(".objField_value").each(function(){
      
         cr_vals[i] = $(this).val();
         i++;
      
      
  });
  
  if($('.cloneThis').is(':checked'))
  {
  cloneIndex = $("input[name='clone']:checked").attr('id').replace('c','');
  console.log('clone==>'+cloneIndex);
  cloneField = $("input[name='clone']:checked").prev().prev().prev().val();
  console.log('clone field==>'+cloneField);
  clone_cr_vals =  $("input[name='clone']:checked").prev().val().split(';');
  console.log('clone field value==>'+clone_cr_vals );
  }
  else
  {
    console.log('nothing is checked');
  }
  
  if ($('#sharefromClone').is(":checked"))
    {
      cloneShareFrom ='1';
      clone_shareFrom_vals = $("#SFName").val().split(';');
    }
  if ($('#sharewithClone').is(":checked"))
    {
      cloneShareWith ='1';
      clone_shareWith_vals = $("#SWName").val().split(';');
      
    }
  
  
  if(ruletype == 'sharingCriteriaRules')
     {
          if(cloneIndex == "0" && cloneShareWith =='0')//00-PASS
          {
              individual_rules[0] = createRule('sharingCriteriaRules',NamePre+rulename+NameSuf,ruleLabel,ruledesc,accesslevel,filterLogic,sharewithType,sharewithName,sharefromType,sharefromName,cr_fields,cr_ops,cr_vals,cloneField,'');
          }
          if(cloneIndex == "0" && cloneShareWith =='1')  //01-PASS
          {
            for(var i=0;i<clone_shareWith_vals.length;i++) 
              individual_rules[i] = createRule('sharingCriteriaRules',NamePre+rulename+'_'+clone_shareWith_vals[i]+NameSuf,ruleLabel,ruledesc,accesslevel,filterLogic,sharewithType,clone_shareWith_vals[i],sharefromType,sharefromName,cr_fields,cr_ops,cr_vals,cloneField,'');
          }
          //////////////////////////////////////////////////////
          if(cloneIndex != "0" && cloneShareWith =='1')  //11-PASS
          {
            if(clone_shareWith_vals.length != clone_cr_vals.length)
            {
               alert('Values Not in Sync');
            }
            else
            {
               for(var i=0;i<clone_shareWith_vals.length;i++) 
                 individual_rules[i] = createRule('sharingCriteriaRules',NamePre+rulename+'_'+clone_cr_vals[i]+'_'+clone_shareWith_vals[i]+NameSuf,ruleLabel,ruledesc,accesslevel,filterLogic,sharewithType,clone_shareWith_vals[i],sharefromType,sharefromName,cr_fields,cr_ops,cr_vals,cloneField,clone_cr_vals[i]);
            }     
          }
          if(cloneIndex != "0" && cloneShareWith =='0')  //10-PASS
          {
               for(var i=0;i<clone_cr_vals.length;i++) 
                 individual_rules[i] = createRule('sharingCriteriaRules',NamePre+rulename+'_'+clone_cr_vals[i]+NameSuf,ruleLabel,ruledesc,accesslevel,filterLogic,sharewithType,sharewithName,sharefromType,sharefromName,cr_fields,cr_ops,cr_vals,cloneField,clone_cr_vals[i]);
          }
          /////////////////////////////////////////////////////// 
      }     
  if(ruletype == 'sharingOwnerRules')
     {
          if(cloneShareFrom == "0" && cloneShareWith =='0') //00-PASS
          {
             individual_rules[0] = createRule('sharingOwnerRules',NamePre+rulename+NameSuf,ruleLabel,ruledesc,accesslevel,filterLogic,sharewithType,sharewithName,sharefromType,sharefromName,cr_fields,cr_ops,cr_vals,cloneField,'');
          
          }
          if(cloneShareFrom == "0" && cloneShareWith =='1') //01-PASS
          {
             for(var i=0;i<clone_shareWith_vals.length;i++)
                individual_rules[i] = createRule('sharingOwnerRules',NamePre+rulename+'_'+clone_shareWith_vals[i]+NameSuf,ruleLabel,ruledesc,accesslevel,filterLogic,sharewithType,clone_shareWith_vals[i],sharefromType,sharefromName,cr_fields,cr_ops,cr_vals,cloneField,'');
          
          }
          if(cloneShareFrom == "1" && cloneShareWith =='0') //10-PASS
          {
             for(var i=0;i<clone_shareFrom_vals.length;i++)
                individual_rules[i] = createRule('sharingOwnerRules',NamePre+rulename+'_'+clone_shareFrom_vals[i]+NameSuf,ruleLabel,ruledesc,accesslevel,filterLogic,sharewithType,sharewithName,sharefromType,clone_shareFrom_vals[i],cr_fields,cr_ops,cr_vals,cloneField,'');
          
          }
          if(cloneShareFrom == "1" && cloneShareWith =='1') //11
          {
             if(clone_shareFrom_vals.length != clone_shareWith_vals.length)
             {
               alert('Values Not in Sync');
             }
             else
             { 
                 for(var i=0;i<clone_shareFrom_vals.length;i++)
                    individual_rules[i] = createRule('sharingOwnerRules',NamePre+rulename+'_'+clone_shareFrom_vals[i]+'_'+clone_shareWith_vals[i]+NameSuf,ruleLabel,ruledesc,accesslevel,filterLogic,sharewithType,clone_shareWith_vals[i],sharefromType,clone_shareFrom_vals[i],cr_fields,cr_ops,cr_vals,cloneField,'');
             }
          }
          
     }
  
  
  
  
  console.log(individual_rules);
  var Rulearr = Array.from(individual_rules);
   
    updateXMLpane(Rulearr,ruletype);
    
  
  var targetObjNmae = $('.objname').text()+'.sharingRules';
  
  selected_multiobject.push($('.objname').text());
  
  
  if(selected_multiobject.length > 1 && confirm('Are you sure to add Sharing rule to '+selected_multiobject.length+ ' objects? \nClick Ok to add to all objects \nClick Cancle to add to '+$('.objname').text())) 
  {
     $(".loaderimg").show();
     
     addtoMultipleObject(individual_rules);
     
  }
  else
  {
          $('#myModal').modal('hide');
          cloneIndex == "-1"
  }   
     

}


function addtoMultipleObject(rule)
{
    //console.log(rule);
    var targetObjNmae = selected_multiobject.pop()+'.sharingRules';
     
     if(zip.folder('sharingRules').file(targetObjNmae) == null)
     {
        zip.folder('sharingRules').file(targetObjNmae,formatXml('<?xml version="1.0" encoding="UTF-8"?><SharingRules xmlns="http://soap.sforce.com/2006/04/metadata"/>'));
     
     }
     
     zip.folder('sharingRules').file(targetObjNmae).async("string").then(function (data) {
                                  
                                  try
                                  {
                                      var xmlDoc = parser.parseFromString(data,"text/xml");    
                                      var criteriarules = xmlDoc.getElementsByTagName("SharingRules")[0];
                                          if(rule.length>1)
                                          {
                                             for(var r=0;r<rule.length;r++)
                                               {
                                                 console.log(r);
                                                 criteriarules.appendChild(rule[r]);
                                               }
                                          }
                                          else
                                            criteriarules.appendChild(rule[0]);
                                      var fs = new XMLSerializer().serializeToString(xmlDoc.documentElement);
                                      //deployzip.folder('sharingRules').file(targetObjNmae,formatXml('<?xml version="1.0" encoding="UTF-8"?>'+fs));
                                      deployzip.file('root/sharingRules/'+targetObjNmae,formatXml('<?xml version="1.0" encoding="UTF-8"?>'+fs));
                                      if(selected_multiobject.length == 0)
                                        $('#myModal').modal('hide');
                                      else
                                        addtoMultipleObject(rule);
                                  
                                  }
                                  catch(err)
                                  {
                                    concole.log(err.message);
                                  }
                                  
                                  
                    });
}


function dwnldZip()
{
   var targetObjNmae = $('.objname').text()+'.sharingRules';
   var targetXML = $(".XMLPane").text();
   deployzip.file('root/sharingRules/'+targetObjNmae,targetXML);
   
   var allcriteria='';
   var allowner = ''
   
   var rules2add = deployComponent.slice(0, -1).split('-');
   
   for(var i=0;i<rules2add.length;i++)
   {
      var eachRule = rules2add[i];
      
      if(deploycomponent_type[eachRule] == 'sharingCriteriaRules')
      {
        allcriteria+= '<members>'+eachRule+'</members>';
      }
      if(deploycomponent_type[eachRule] == 'sharingOwnerRules')
      {
        allowner+= '<members>'+eachRule+'</members>';
      }
   
   }
   
   
   deployzip.file('root/package.xml','<?xml version="1.0" encoding="UTF-8"?><Package xmlns="http://soap.sforce.com/2006/04/metadata"><types>'+allcriteria+'<name>SharingCriteriaRule</name></types><types>'+allowner+'<name>SharingOwnerRule</name></types><version>46.0</version></Package>'); 
   
   
   deployzip.generateAsync({type:"blob"})
    .then(function (blob) {
        saveAs(blob, "deployzip.zip");
    });
  
}

function resetall()
{
  $(".addedNotification").text('');
  selected_multiobject = [];
  $(".multiobjectselection").each(function(){
    $(".multiobjectselection"). prop("checked", false);
  });
  $('.sc1').show();
  $('.sc2').hide();
  $('.ownerBased').hide();
  $("#CRRadio").prop("checked", true);
  $("#shareWithType").val('group');
  $("#shareFromType").val('group');
  if($('.objname').text() == 'Account')
    {
      $(".acconly").show();
      $("#acclevel").attr('disabled','true');
    }
  else
    {
      $(".acconly").hide();
      $("#acclevel").removeAttr('disabled');
    }
  $('#myModal').modal({backdrop: 'static', keyboard: false});
  resetFieldsEdit_new();
  populateObjfields('objField');
  
}
function populateObjfields(element)
{
   var el = element+'';
   currentObjFieldTypeMap = [];  
   if(el.indexOf('_edit')!=-1)
   {
               var lastel = $("."+el).last();
               
              lastel.append($("<option />").val('none').text('--None--'));
              for(var i=0;i<currentObjDescribe.fields.length;i++)
              {
                
                var FT = currentObjDescribe.fields[i].type;
                var FN = currentObjDescribe.fields[i].name;
                console.log(FT+'-'+FN);
                if(FN != 'IsDeleted' && FN != 'Id' && FT != 'datetime' && FT != 'reference' && FT != 'multipicklist' && FT != 'location' && FT != 'currency' && FT !='encryptedstring' 
                    && FT !='textarea' )
                {  
                  
                  lastel.append($("<option />").val(currentObjDescribe.fields[i].name).text(currentObjDescribe.fields[i].name));
                  currentObjFieldTypeMap[FN]=FT;
                }
                if(FN=='OwnerId' ||FN =='CreatedById'||FN =='LastModifiedById')
                {
                  lastel.append($("<option />").val(currentObjDescribe.fields[i].name).text(currentObjDescribe.fields[i].name));
                  currentObjFieldTypeMap[FN]=FT;
                }   
                if(FT == 'textarea' && currentObjDescribe.fields[i].length == 255)
                {
                  lastel.append($("<option />").val(currentObjDescribe.fields[i].name).text(currentObjDescribe.fields[i].name));
                  currentObjFieldTypeMap[FN]=FT;
                }
                
              } 
      
   }
   else
   {       
       $("."+el).each(function(this_ele){
          
          
          
              $(this).empty();
              $(this).append($("<option />").val('none').text('--None--'));
              for(var i=0;i<currentObjDescribe.fields.length;i++)
              {
                
                var FT = currentObjDescribe.fields[i].type;
                var FN = currentObjDescribe.fields[i].name;
                console.log(FT+'-'+FN);
                if(FN != 'IsDeleted' && FN != 'Id' && FT != 'datetime' && FT != 'reference' && FT != 'multipicklist' && FT != 'location' && FT != 'currency' && FT !='encryptedstring' 
                    && FT !='textarea' )
                {  
                  
                  $(this).append($("<option />").val(currentObjDescribe.fields[i].name).text(currentObjDescribe.fields[i].name));
                  currentObjFieldTypeMap[FN]=FT;
                }
                if(FN=='OwnerId' ||FN =='CreatedById'||FN =='LastModifiedById')
                {
                  $(this).append($("<option />").val(currentObjDescribe.fields[i].name).text(currentObjDescribe.fields[i].name));
                  currentObjFieldTypeMap[FN]=FT;
                }   
                if(FT == 'textarea' && currentObjDescribe.fields[i].length == 255)
                {
                  $(this).append($("<option />").val(currentObjDescribe.fields[i].name).text(currentObjDescribe.fields[i].name));
                  currentObjFieldTypeMap[FN]=FT;
                }
                
              } 
                    
          
          
      });
   }
}

function populateOperators()
{
    
    var fieldName = $(this).val();
    var fieldType = currentObjFieldTypeMap[fieldName];
    var opElement = $(this).next();
    opElement.empty();
    opElement.next().attr('title','');
    
    //assign none at the top
    opElement.append($("<option />").val('none').text('--None--'));
    
    if(fieldType =='string' || fieldType =='textarea' || fieldType =='url' || fieldType =='number' || fieldType =='email'|| fieldType =='phone')
    {
                opElement.append($("<option />").val('equals').text('Equals'));
                opElement.append($("<option />").val('notEqual').text('Not equal to'));
                opElement.append($("<option />").val('contains').text('Contains'));
                opElement.append($("<option />").val('notContain').text('Not Contain'));
                opElement.append($("<option />").val('startsWith').text('Starts With'));
    }
        
       
    if(fieldType =='reference')
    {
                opElement.append($("<option />").val('equals').text('Equals'));
                opElement.append($("<option />").val('notEqual').text('Not equal to'));
                opElement.append($("<option />").val('startsWith').text('Starts With'));
    }
    
    if(fieldType =='boolean' || fieldType =='picklist')
    {
                opElement.append($("<option />").val('equals').text('Equals'));
                opElement.append($("<option />").val('notEqual').text('Not equal to'));
                populateValues(fieldName,opElement);
    }
    
    if(fieldType =='percent' || fieldType =='time' || fieldType =='date' || fieldType =='double' || fieldType =='location')
    {
                opElement.append($("<option />").val('equals').text('Equals'));
                opElement.append($("<option />").val('notEqual').text('Not equal to'));
                opElement.append($("<option />").val('lessThan').text('Less than'));
                opElement.append($("<option />").val('greaterThan').text('Greater than'));
                opElement.append($("<option />").val('lessOrEqual').text('Less or equal'));
                opElement.append($("<option />").val('greaterOrEqual').text('Greater or equal'));
                
    }
}

function populateValues(fieldName,opElement)
{
    alert('Hold your pointer on the input text to see available values');
    var title='';
    for(var i=0;i<currentObjDescribe.fields.length;i++)
    {
       if(currentObjDescribe.fields[i].name == fieldName+'')  
       {
           if(currentObjDescribe.fields[i].type == 'boolean')
           {
               title+='True'+'\n'+'False';
           }
           else
           {               
               for(var j=0;j<currentObjDescribe.fields[i].picklistValues.length;j++)
                {
                    title+=currentObjDescribe.fields[i].picklistValues[j].value+'\n';
                }
           }
       }
    }
    
    opElement.next().attr('title',title);
    
    
}

function resetFieldsEdit_new()
{
  $(".clearthis").each(function(){
    if($(this).attr('type')=='checkbox')
      $(this).prop("checked", false);
    if($(this).attr('type')=='text')
      $(this).val('');  
    if($(this).attr('name')=='message')
      $(this).val('');
    if($(this).is('select'))
      $(this).empty();  
  });
}
  </script>
  <script>
  
     function editRule()
     {
     
       var objname_edit =  $('.objname').text();
       var rulename_edit = $(this).attr("data-rulename");
       var rule_type_edit = $(this).attr("data-rtype");
       var accesslevel_edit = $(this).attr("data-alev");
       var label_edit = $(this).attr("data-lbl");
       var sharedto_type_edit = $(this).attr("data-shto");
       var sharedto_name_edit = $(this).attr("data-shton");
       var sharedfrom_type_edit = $(this).attr("data-shfrm");
       var sharedfrom_name_edit = $(this).attr("data-shfrmn");
       var criteria_edit = [];
       var crLogic_edit = $(this).attr("data-crlg") == 'AND applies for all'?'':$(this).attr("data-crlg");
       
       
       if(rule_type_edit == 'sharingCriteriaRules')
       {
         
         $(".criteriaEditpane").show();
         $(".shareFromEditpane").hide();
         $("#ruletype").val('sharingCriteriaRules');
         
         
       }
       if(rule_type_edit == 'sharingOwnerRules')
       {
         
         $(".shareFromEditpane").show();
         $(".criteriaEditpane").hide();
         $("#ruletype").val('sharingOwnerRules');
         
         
       }
       
       $(".editFieldrows").empty();
       
       
       //populating all text fields
       
       $(".editmodal-header").text("Edit " + rulename_edit );
       $("#ruleName_edit").val(rulename_edit);
       $("#ruleLabel_edit").val(label_edit);
       $("#CriteriaFiletrLogic_edit").val(crLogic_edit);
       $("#SWName_edit").val(sharedto_name_edit);
       $("#SFName_edit").val(sharedfrom_name_edit);
       
       //alert(sharedto_name_edit);
       //alert(sharedfrom_name_edit);
       
       
       //populating access picklist
       
       if($('.objname').text() == 'Account')
       {
            var acclevelArr = accesslevel_edit.split('-');
            $(".acconly_edit").show();
            $("#acclevelaccess_edit").val(acclevelArr[1]);
            $("#opplevelaccess_edit").val(acclevelArr[2]);
            $("#caselevelaccess_edit").val(acclevelArr[0]);
         
       }
       else
       {
           $(".acconly_edit").hide();
           if(accesslevel_edit == 'Read' ||accesslevel_edit == 'read')
             $("#acclevel_edit").val("Read");
           if(accesslevel_edit == 'Edit' ||accesslevel_edit == 'edit')
             $("#acclevel_edit").val("Edit");  
       
       }

      //populating field rows
       
      if(rule_type_edit == 'sharingCriteriaRules')
      {
       $(this).parent().prev().prev().find("ol").find("li").each(function(index){
       
              var crString = $(this).text();
              
              var field = crString.split(' ')[0];
              var optr = crString.split(' ')[1];
              var value = crString.split(' ').slice(2);
              
              $(".editFieldrows").append('<select class="objField_edit" value="" data-fld="" onchange="populateOperators.call(this)"/>');
              $(".editFieldrows").append('<select class="objField_oprator_edit"  id="optr'+index+'_edit"/>');
              $(".editFieldrows").append('<input type="text" class="objField_value_edit" data-toggle="tooltip" title="" value="'+value+'"/>');
              
              if(index!=0)
               $(".editFieldrows").append('<span class="likebutton" onclick="removerow.call(this);"><b><font color="red" size="4">&nbsp;&nbsp;X&nbsp;&nbsp;</font></b></span><br/><br/>');
              else
               $(".editFieldrows").append('<br/><br/>'); 
           
              populateObjfields('objField_edit');
              
              
              //$(".objField_edit").eq(index).val(field);//.trigger('change');
              //$(".objField_edit").eq(index).find('option[value="'+field+'"]').attr('selected','selected')
              //$("#optr"+index+"_edit").val(optr);
              
              
              
        });
        
        $(this).parent().prev().prev().find("ol").find("li").each(function(index){
              
              var crString = $(this).text();
              
              var field = crString.split(' ')[0];
              var optr = crString.split(' ')[1];
              var value = crString.split(' ').slice(2);
            
              $(".objField_edit").eq(index).val(field).trigger('change');
              $(".objField_edit").eq(index).val(field);
              $("#optr"+index+"_edit").val(optr);
        });
      }
        
        //populating shareto type
        if(sharedto_type_edit == 'Role')
          $("#shareWithType_edit").val('role');
        if(sharedto_type_edit == 'Role & Subordinates')
          $("#shareWithType_edit").val('rolesubordinate');
        if(sharedto_type_edit == 'Public Group')
          $("#shareWithType_edit").val('group');
        
        //populating sharefrom type
        if(sharedfrom_type_edit == 'Role')
          $("#shareFromType_edit").val('role');
        if(sharedfrom_type_edit == 'Role & Subordinates')
          $("#shareFromType_edit").val('rolesubordinate');
        if(sharedfrom_type_edit == 'Public Group')
          $("#shareFromType_edit").val('group');
        
          
        //populate relation
          
          
     }
  
     function addfieldrow()
     {
              $(".editFieldrows").append('<select class="objField_edit" value="" data-fld="" onchange="populateOperators.call(this)"/>');
              $(".editFieldrows").append('<select class="objField_oprator_edit"  id="optr_edit"/>');
              $(".editFieldrows").append('<input type="text" class="objField_value_edit" data-toggle="tooltip" title="" value=""/>');
              $(".editFieldrows").append('<span class="likebutton" onclick="removerow.call(this);"><b><font color="red" size="4">&nbsp;&nbsp;X&nbsp;&nbsp;</font></b></span><br/><br/>');
              populateObjfields('objField_edit');
     
     
     }
    function removerow()
    {
    
      $(this).prev().remove();
      $(this).prev().remove();
      $(this).prev().remove();
      $(this).next().remove();
      $(this).next().remove();
      $(this).remove();
    }
  
   function saveEdited()
   {
      var ruletype = $("#ruletype").val();
      var objname_edit =  $('.objname').text();
      var rulename_edit = $(".editmodal-header").text().replace('Edit ','');
      var ruleLabel = $('#ruleLabel_edit').val();      
      var ruledesc = $('#ruledesc_edit').val();
      var accesslevel = $( "#acclevel_edit" ).val();
      var filterLogic = $( "#CriteriaFiletrLogic_edit" ).val();
      var sharewithType = $('#shareWithType_edit').val();
      var sharewithName = $('#SWName_edit').val();
      var lodedData = $(".XMLPane").text();
      parser = new DOMParser();
      xmlDoc = parser.parseFromString(lodedData,"text/xml");
      
      
      
   if(ruletype == 'sharingCriteriaRules')
   {     
      var cr_fields = [];
      var cr_ops = [];
      var cr_vals = [];
      
      
   
      var i= 0;
      $(".objField_edit").each(function(){
          var fieldName = $(this).val();
          if( fieldName.length > 0)
          {
             cr_fields[i] = fieldName;
             i++;
          }
          
      });
      
      i= 0;
      $(".objField_oprator_edit").each(function(){
          var opName = $(this).val();
          if( opName.length > 0)
          {
             cr_ops[i] = opName ;
             i++;
          }
          
      });
      
      i= 0;
      $(".objField_value_edit").each(function(){
          
             cr_vals[i] = $(this).val();
             i++;
          
          
      });
      
      
      var criteriarules = xmlDoc.getElementsByTagName("sharingCriteriaRules");
      for(var i=0;i<criteriarules.length;i++)
      {
        
        if(criteriarules[i].getElementsByTagName('fullName')[0].innerHTML == rulename_edit)
        {
          //XMLDOC manupulation for display
          
          xmlDoc.getElementsByTagName("sharingCriteriaRules")[i].getElementsByTagName('label')[0].innerHTML = ruleLabel ;
          
          xmlDoc.getElementsByTagName("sharingCriteriaRules")[i].getElementsByTagName('accessLevel')[0].innerHTML = accesslevel ;
          
          if(filterLogic.length>0 && xmlDoc.getElementsByTagName("sharingCriteriaRules")[i].getElementsByTagName('booleanFilter').length>0)
          { 
           xmlDoc.getElementsByTagName("sharingCriteriaRules")[i].getElementsByTagName('booleanFilter')[0].innerHTML = filterLogic ;
          }
          else
          {
             if(filterLogic.length>0 && xmlDoc.getElementsByTagName("sharingCriteriaRules")[i].getElementsByTagName('booleanFilter').length == 0)  
              {
               var bfilter = document.createElement('booleanFilter');
               bfilter.innerHTML = filterLogic;
               
               xmlDoc.getElementsByTagName("sharingCriteriaRules")[i].appendChild(bfilter);
              }
          } 
          
          if(ruledesc && xmlDoc.getElementsByTagName("sharingCriteriaRules")[i].getElementsByTagName('description').length>0)
          {
           xmlDoc.getElementsByTagName("sharingCriteriaRules")[i].getElementsByTagName('description')[0].innerHTML = ruledesc;
          }
          else
          {
              if(ruledesc && xmlDoc.getElementsByTagName("sharingCriteriaRules")[i].getElementsByTagName('description').length == 0)
              {
               var description = document.createElement('description');
               description.innerHTML = ruledesc;
               
               xmlDoc.getElementsByTagName("sharingCriteriaRules")[i].appendChild(description);
              }
          } 
          
          var criterias = xmlDoc.getElementsByTagName("sharingCriteriaRules")[i].getElementsByTagName("criteriaItems").length;
          
          for(var j=0;j<criterias;j++)
          {
            console.log('removed--'+j);
            var n  = xmlDoc.getElementsByTagName("sharingCriteriaRules")[i].getElementsByTagName("criteriaItems")[0];
            xmlDoc.getElementsByTagName("sharingCriteriaRules")[i].removeChild(n);
          }
          
          
          
             for(var j=0;j<cr_fields.length;j++)
             {
                if(cr_fields[j].length>0 && cr_ops[j].length>0)
                {
                   var criteriaItems_e = document.createElement('criteriaItems');
                   
                   
                   var field_e = document.createElement('field');
                       field_e.innerHTML = cr_fields[j];
                   var operation_e = document.createElement('operation');
                       operation_e.innerHTML = cr_ops[j];     
                   var value_e = document.createElement('value');
                       value_e.innerHTML = cr_vals[j];      
                       
                   
                   criteriaItems_e.appendChild(field_e);
                   criteriaItems_e.appendChild(operation_e);
                   criteriaItems_e.appendChild(value_e);
                   
                  xmlDoc.getElementsByTagName("sharingCriteriaRules")[i].appendChild(criteriaItems_e);   
                  console.log('added--'+j);                
                }
             
             }
           
           
          includecomponent(rulename_edit,'sharingCriteriaRules');
          
        }
      }
   }   
   
   if(ruletype == 'sharingOwnerRules')
   {
              var criteriarules = xmlDoc.getElementsByTagName("sharingOwnerRules");
              for(var i=0;i<criteriarules.length;i++)
              {
                
                if(criteriarules[i].getElementsByTagName('fullName')[0].innerHTML == rulename_edit)
                {
                  //XMLDOC manupulation for display
                  
                  xmlDoc.getElementsByTagName("sharingOwnerRules")[i].getElementsByTagName('label')[0].innerHTML = ruleLabel ;
                  xmlDoc.getElementsByTagName("sharingOwnerRules")[i].getElementsByTagName('accessLevel')[0].innerHTML = accesslevel ;
                  includecomponent(rulename_edit,'sharingOwnerRules');
               
                }
              } 
      
   
   }
   
   
   
      var displayxml = new XMLSerializer().serializeToString(xmlDoc.documentElement);
      displayxml = '<?xml version="1.0" encoding="UTF-8"?>\n'+formatXml(displayxml);
      displayxml = displayxml.replace('/^\s*[\r\n]/gm','');
      $(".XMLPane").text(displayxml);
      populateRules(displayxml);
      $('#editModal').modal('hide');
      console.log(xmlDoc);
      
   }
  
  function updateXMLpane(rules,type)
  {
      var lodedData = $(".XMLPane").text();
      parser = new DOMParser();
      xmlDoc = parser.parseFromString(lodedData,"text/xml");
      
      if(type == 'sharingOwnerRules')
      {
          if(xmlDoc.getElementsByTagName("SharingRules").length > 0)
          {
              if(xmlDoc.getElementsByTagName("SharingRules")[0].getElementsByTagName("sharingOwnerRules") && xmlDoc.getElementsByTagName("SharingRules")[0].getElementsByTagName("sharingOwnerRules").length>0)
              {
                  var templength = xmlDoc.getElementsByTagName("SharingRules")[0].getElementsByTagName("sharingOwnerRules").length;
                  for(var i=0;i<rules.length;i++)
                  {   
                     docEL = xmlDoc.documentElement;
                     lastEL =  xmlDoc.getElementsByTagName("SharingRules")[0].getElementsByTagName("sharingOwnerRules")[templength-1];                    
                     docEL.insertBefore(rules[i],lastEL);
                  }  
              }
              else //if(!xmlDoc.getElementsByTagName("SharingRules")[0].getElementsByTagName("sharingOwnerRules"))
              {
                  for(var i=0;i<rules.length;i++)
                    xmlDoc.getElementsByTagName("SharingRules")[0].appendChild(rules[i]);
              }
          }
          
          //for(var i=0;i<rules.length;i++)
           //xmlDoc.getElementsByTagName("SharingRules")[0].appendChild(rules[i]);
      }
      
      if(type == 'sharingCriteriaRules')
      {
          //alert('sharingCriteriaRules');
          if(xmlDoc.getElementsByTagName("SharingRules").length > 0)
          {
             //alert('SharingRules > 0');
             if(xmlDoc.getElementsByTagName("SharingRules")[0].getElementsByTagName("sharingCriteriaRules") && xmlDoc.getElementsByTagName("SharingRules")[0].getElementsByTagName("sharingCriteriaRules").length>0)
              {
                  //alert('sharingCriteriaRules > 0');
                  var templength = xmlDoc.getElementsByTagName("SharingRules")[0].getElementsByTagName("sharingCriteriaRules").length;
                  for(var i=0;i<rules.length;i++)
                  {   
                     docEL = xmlDoc.documentElement;
                     lastEL =  xmlDoc.getElementsByTagName("SharingRules")[0].getElementsByTagName("sharingCriteriaRules")[templength-1];                    
                     docEL.insertBefore(rules[i],lastEL);
                  }  
              }
              else  //if(!xmlDoc.getElementsByTagName("SharingRules")[0].getElementsByTagName("sharingCriteriaRules"))
              {
                  //alert('sharingCriteriaRules == 0');
                  for(var i=0;i<rules.length;i++)
                    xmlDoc.getElementsByTagName("SharingRules")[0].appendChild(rules[i]);
              }
          
          }
          //for(var i=0;i<rules.length;i++)
               //xmlDoc.getElementsByTagName("SharingRules")[0].appendChild(rules[i]);
      }
      
      
      var displayxml = new XMLSerializer().serializeToString(xmlDoc.documentElement);
      displayxml = '<?xml version="1.0" encoding="UTF-8"?>\n'+formatXml(displayxml);
      $(".XMLPane").text(displayxml);
      populateRules(displayxml);
  }
  
  
  function deployZip()
  {
  
   var targetObjNmae = $('.objname').text()+'.sharingRules';
   var targetXML = $(".XMLPane").text();
   deployzip.file('root/sharingRules/'+targetObjNmae,targetXML);
   
   var allcriteria='';
   var allowner = ''
   
   var rules2add = deployComponent.slice(0, -1).split('-');
   
   for(var i=0;i<rules2add.length;i++)
   {
      var eachRule = rules2add[i];
      
      if(deploycomponent_type[eachRule] == 'sharingCriteriaRules')
      {
        allcriteria+= '<members>'+eachRule+'</members>';
      }
      if(deploycomponent_type[eachRule] == 'sharingOwnerRules')
      {
        allowner+= '<members>'+eachRule+'</members>';
      }
   
   }
   
   
   deployzip.file('root/package.xml','<?xml version="1.0" encoding="UTF-8"?><Package xmlns="http://soap.sforce.com/2006/04/metadata"><types>'+allcriteria+'<name>SharingCriteriaRule</name></types><types>'+allowner+'<name>SharingOwnerRule</name></types><version>46.0</version></Package>'); 
  
  
    deployzip.generateAsync({type:"base64"}).then(function (base64) {
       //location.href="data:application/zip;base64," + base64;
       var zipInput =  base64;   //"data:application/zip;base64," +
      conn.metadata.deploy(zipInput,{autoUpdatePackage:'true'},function(err,result){
        
        console.log(result.id);
        console.log(result.state);
        $("#deploymentModal").modal({backdrop:'static',keybord:'false'});
        $(".loaderimg").show();
        $(".deployclose").hide();
        $("#deploymentprob").empty();
        $("#deploymentstat").text(result.state);
        checkdeploystat(result.id);
         
      });
      
       
       
    });
  
  }
  function populateErrorLog(stateObj)
  {
     var probtext = '';
     if(stateObj instanceof Array)
     {
         for(var i=0;i<stateObj.length;i++)
                            {
                                probtext += '<li><b>Rule Name :</b> '+stateObj[i].fullName+' <b>Error</b> '+stateObj[i].problem+'</li>';
                            } 
     }
     else
     {
         probtext += '<li><b>Rule Name :</b> '+stateObj.fullName+' <b>Error</b> '+stateObj.problem+'</li>';
     }
        $("#deploymentprob").append(probtext);
        console.log(probtext);
  }
  
  function checkdeploystat (retid)
    {
       conn.metadata.checkDeployStatus(retid,true,function(err,result){
           if(result.status != 'Succeeded')
           {
             if(result.status == 'Failed' || result.status == 'SucceededPartial')
             {
                
                $(".loaderimg").hide();
                $("#deploymentstat").text('Failed - Please wait while we fetch the error log');
                setTimeout( populateErrorLog (result.details.componentFailures) , 10000);
                $(".deployclose").show();
                
                
             }   
             else
             {
                checkdeploystat(retid);
                $("#deploymentstat").text(result.status);
             }
           }
           else 
           {
             
             $("#deploymentstat").text(result.status);
             setTimeout(function(){ $('#deploymentModal').modal('hide'); }, 3000);
             
             
           }  
           console.log(result);
       });
       
    }
  
  </script>
  <script>
  function formatXml(xml) {
    var formatted = '';
    var reg = /(>)(<)(\/*)/g;
    xml = xml.replace(reg, '$1\r\n$2$3');
    var pad = 0;
    jQuery.each(xml.split('\r\n'), function(index, node) {
        var indent = 0;
        node = node.replace(' xmlns="http://www.w3.org/1999/xhtml"','');
        node = node.replace(' xmlns=""','')
        node = node.replace('<criteriaitems>','<criteriaItems>').replace('</criteriaitems>','</criteriaItems>');
        node = node.replace('<booleanfilter>','<booleanFilter>').replace('</booleanfilter>','</booleanFilter>');
        node = node.replace('<allInternalUsers> </allInternalUsers>','<allInternalUsers></allInternalUsers>');
        if (node.match( /.+<\/\w[^>]*>$/ )) {
            indent = 0;
        } else if (node.match( /^<\/\w/ )) {
            if (pad != 0) {
                pad -= 1;
            }
        } else if (node.match( /^<\w([^>]*[^\/])?>.*$/ )) {
            indent = 1;
        } else {
            indent = 0;
        }

        var padding = '';
        for (var i = 0; i < pad; i++) {
            padding += '  ';
        }

        formatted += padding + node + '\r\n';
        pad += indent;
    });

    return formatted;
}

$(".cloneThis").click(function(){
 alert("Field values on this row must be ';' separated to apply clonning");
});
$(".cloneThis_share").click(function(){
 alert("Field values on this row must be ';' separated to apply clonning");
});
  </script>
<script>
function createRule(ruletype,rulename,ruleLabel,ruledesc,accesslevel,filterLogic,sharewithType,sharewithName,sharefromType,sharefromName,cr_fields,cr_ops,cr_vals,cloneField,clonedValue)
{
   var doc = document.implementation.createDocument("", "", null);
   if(ruletype == 'sharingCriteriaRules')
     {
                //Rule Creation Start
                  var ruleElement = doc.createElement(ruletype);
                  var fullname_e = doc.createElement('fullName');
                     fullname_e.innerHTML=rulename.replace(/[^\w\s]/gi,'').replace(' ','_');
                     ruleElement.appendChild(fullname_e);
                     includecomponent(rulename,'sharingCriteriaRules');
                     
                  var label_e = doc.createElement('label');
                     label_e.innerHTML = ruleLabel.replace(/[^\w\s]/gi,'');
                     ruleElement.appendChild(label_e);
                     
                  var ruledesc_e = doc.createElement('description');
                     ruledesc_e.innerHTML = ruledesc;
                     ruleElement.appendChild(ruledesc_e);
                  
                  if($('.objname').text() == 'Account')
                  {
                     var accessLevel_e = doc.createElement('accessLevel');
                         accessLevel_e.innerHTML = contact_level;
                         ruleElement.appendChild(accessLevel_e);
                     
                     var accsettings_e = doc.createElement('accountSettings');
                     var casesettings_e = doc.createElement('caseAccessLevel');
                         casesettings_e.innerHTML=case_level;
                     var contactsettings_e = doc.createElement('contactAccessLevel');
                         contactsettings_e.innerHTML=contact_level;
                     var oppsettings_e = doc.createElement('opportunityAccessLevel');
                         oppsettings_e.innerHTML=opp_level;
                        
                        accsettings_e.appendChild(casesettings_e);
                        accsettings_e.appendChild(contactsettings_e);
                        accsettings_e.appendChild(oppsettings_e);
                        
                        ruleElement.appendChild(accsettings_e);
                     
                  }
                  else
                  {
                     var accessLevel_e = doc.createElement('accessLevel');
                         accessLevel_e.innerHTML = accesslevel;
                         ruleElement.appendChild(accessLevel_e);
                  }
                  
                  if(filterLogic.length>0)
                  {
                   var filetrlogic_e = doc.createElement('booleanFilter');
                     filetrlogic_e.innerHTML = filterLogic;
                     ruleElement.appendChild(filetrlogic_e);
                  }
                 
                  var sharedTo_e = doc.createElement('sharedTo');
                  var sharetype_e;
                   if(sharewithType == 'role')
                    {
                      sharetype_e  = doc.createElement('role');
                      sharetype_e.innerHTML = sharewithName;
                    }   
                    if(sharewithType == 'rolesubordinate')
                    {
                       sharetype_e = doc.createElement('roleAndSubordinates');
                       sharetype_e.innerHTML = sharewithName;
                    }
                    if(sharewithType == 'group')
                    {
                       if(sharewithName != 'All Internal Users')
                       {
                         sharetype_e = doc.createElement('group');
                         sharetype_e.innerHTML = sharewithName;
                       }  
                       else
                       {
                         var internal = doc.createElement('allInternalUsers');
                         internal.innerHTML = ' ';
                         sharedTo_e.appendChild(internal);
                       }  
                    
                    }
                   if(sharetype_e)
                       sharedTo_e.appendChild(sharetype_e);
                   ruleElement.appendChild(sharedTo_e);
                   
                   if(clonedValue == '')
                   {
                     for(var j=0;j<cr_fields.length;j++)
                     {
                        if(cr_fields[j].length>0 && cr_ops[j].length>0)
                        {
                           var criteriaItems_e = doc.createElement('criteriaItems');
                           
                           
                           var field_e = doc.createElement('field');
                               field_e.innerHTML = cr_fields[j];
                           var operation_e = doc.createElement('operation');
                               operation_e.innerHTML = cr_ops[j];     
                           var value_e = doc.createElement('value');
                               value_e.innerHTML = cr_vals[j];      
                               
                           
                           criteriaItems_e.appendChild(field_e);
                           criteriaItems_e.appendChild(operation_e);
                           criteriaItems_e.appendChild(value_e);
                           
                          ruleElement.appendChild(criteriaItems_e);                   
                        }
                     
                     }
                   
                   }
                  if(clonedValue != '')
                   {
                     for(var j=0;j<cr_fields.length;j++)
                     {
                        if(cr_fields[j].length>0 && cr_ops[j].length>0)
                        {
                           var criteriaItems_e = doc.createElement('criteriaItems');
                           
                           
                           var field_e = doc.createElement('field');
                               field_e.innerHTML = cr_fields[j];
                           var operation_e = doc.createElement('operation');
                               operation_e.innerHTML = cr_ops[j];     
                           if(cr_fields[j] == cloneField )
                           {
                              var value_e = doc.createElement('value');
                               value_e.innerHTML = clonedValue;
                           }
                           else
                           {
                             var value_e = doc.createElement('value');
                               value_e.innerHTML = cr_vals[j];      
                           }    
                           
                           criteriaItems_e.appendChild(field_e);
                           criteriaItems_e.appendChild(operation_e);
                           criteriaItems_e.appendChild(value_e);
                           
                          ruleElement.appendChild(criteriaItems_e);                   
                        }
                     
                     }
                   
                   }
     return ruleElement;
     }
     if(ruletype == 'sharingOwnerRules')
     {
            //Rule Creation Start
                  var ruleElement = doc.createElement(ruletype);
                  var fullname_e = doc.createElement('fullName');
                     fullname_e.innerHTML=rulename.replace(/[^\w\s]/gi, '').replace(' ','_');
                     ruleElement.appendChild(fullname_e);
                     includecomponent(rulename,'sharingOwnerRules');
                     
                     
                  var label_e = doc.createElement('label');
                     label_e.innerHTML = ruleLabel.replace(/[^\w\s]/gi, '');
                     ruleElement.appendChild(label_e);
                     
                  var ruledesc_e = doc.createElement('description');
                     ruledesc_e.innerHTML = ruledesc;
                     ruleElement.appendChild(ruledesc_e);
                  
                  if($('.objname').text() == 'Account')
                  {
                     var accessLevel_e = doc.createElement('accessLevel');
                         accessLevel_e.innerHTML = contact_level;
                         ruleElement.appendChild(accessLevel_e);
                     
                     var accsettings_e = doc.createElement('accountSettings');
                     var casesettings_e = doc.createElement('caseAccessLevel');
                         casesettings_e.innerHTML=case_level;
                     var contactsettings_e = doc.createElement('contactAccessLevel');
                         contactsettings_e.innerHTML=contact_level;
                     var oppsettings_e = doc.createElement('opportunityAccessLevel');
                         oppsettings_e.innerHTML=opp_level;
                        
                        accsettings_e.appendChild(casesettings_e);
                        accsettings_e.appendChild(contactsettings_e);
                        accsettings_e.appendChild(oppsettings_e);
                        
                        ruleElement.appendChild(accsettings_e);
                     
                  }
                  else
                  {
                     var accessLevel_e = doc.createElement('accessLevel');
                         accessLevel_e.innerHTML = accesslevel;
                         ruleElement.appendChild(accessLevel_e);
                  }
   
                  var sharedTo_e = doc.createElement('sharedTo');
                  var sharetype_e;
                   if(sharewithType == 'role')
                    {
                      sharetype_e  = doc.createElement('role');
                      sharetype_e.innerHTML = sharewithName;
                    }   
                    if(sharewithType == 'rolesubordinate')
                    {
                       sharetype_e = doc.createElement('roleAndSubordinates');
                       sharetype_e.innerHTML = sharewithName;
                    }
                    if(sharewithType == 'group')
                    {
                       if(sharewithName != 'All Internal Users')
                       {
                         
                         sharetype_e = doc.createElement('group');
                         sharetype_e.innerHTML = sharewithName;
                         
                       }  
                       else
                       {
                         var internal = doc.createElement('allInternalUsers');
                         internal.innerHTML = ' ';
                         sharedTo_e.appendChild(internal);
                       }  
                    }
                   if(sharetype_e)
                       sharedTo_e.appendChild(sharetype_e);
                   ruleElement.appendChild(sharedTo_e);
                   
                   var sharedFrom_e = doc.createElement('sharedFrom');
                   var sharetype_e;
                   if(sharefromType == 'role')
                    {
                      sharetype_e  = doc.createElement('role');
                      sharetype_e.innerHTML = sharefromName ;
                    }   
                    if(sharefromType == 'rolesubordinate')
                    {
                       sharetype_e = doc.createElement('roleAndSubordinates');
                       sharetype_e.innerHTML = sharefromName ;
                    }
                    if(sharefromType == 'group')
                    {
                       if(sharefromName != 'All Internal Users')
                       {
                         sharetype_e = doc.createElement('group');
                         sharetype_e.innerHTML = sharefromName;
                         
                       }  
                       else
                       {
                         var internal = doc.createElement('allInternalUsers');
                         internal.innerHTML = ' ';
                         sharedFrom_e.appendChild(internal);
                       }  
                    }
                   if(sharetype_e)
                       sharedFrom_e.appendChild(sharetype_e);
                   ruleElement.appendChild(sharedFrom_e);
                   
                   doc.appendChild(ruleElement);//adding single rule
                   
        return ruleElement;        
     }
   return null;
}

function populateApi()
{
   $("#ruleName").val($(this).val().replace(/[^\w\s]/gi,'_').replace(' ','_'));
}
</script>

<script type="text/javascript" src="{!URLFOR($Resource.ShareBot,'js/shareChareJS.js')}"></script>
</apex:page>
